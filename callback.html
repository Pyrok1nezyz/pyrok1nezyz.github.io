<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Twitch Rickroll Callback</title>
</head>
<body>
<script type="text/javascript">
    const cryptedText = 'lnymzg_ufy_11FAFWHQF050JQYwlkTCHK_eferq3ctEvBCrANGL7hu9ibti9GPJm8z9Y0nOkibayaGMS5RBQM6MExhbPK';
    //const cryptedText = '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';
    const shift = 5;

    const username = 'pyrok1nezyz';
    const repo = 'pyrok1nezyz.github.io';
    const filePath = 'data/users.json';

    const clientId = 'o8j92ojn066fzkoeq1h7nku48i972w';
    const redirectUri = 'https://pyrok1nezyz.github.io/callback.html';

    function caesarDecipher(text, shift) {
        let result = '';
        for (let i = 0; i < text.length; i++) {
            let charCode = text.charCodeAt(i);
            if (charCode >= 65 && charCode <= 90) {
                // для заглавных букв
                result += String.fromCharCode((charCode - 65 - shift) % 26 + 65);
            } else if (charCode >= 97 && charCode <= 122) {
                // для строчных букв
                result += String.fromCharCode((charCode - 97 - shift) % 26 + 97);
            } else {
                result += text[i];
            }
        }
        return result;
    }

    function getAccessToken() {
        const hash = window.location.hash;
        const params = hash.substring(1).split('&');
        for (const param of params) {
            const [key, value] = param.split('=');
            if (key === 'access_token') {
                return value;
            }
        }
        return null;
    }

    document.addEventListener('DOMContentLoaded',
        function() {
            const accToken = getAccessToken();
            const githubToken = caesarDecipher(cryptedText, shift); // Личный токен GitHub

            if (accToken) {
                window.fetch(`https://api.twitch.tv/helix/users`,
                        {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${accToken}`,
                                'Client-Id': clientId
                            }
                        })
                    .then(response => response.json())
                    .then(data => {
                        const userInfo = data.data[0];

                        const contentUrl = `https://jsonblob.com/api/jsonBlob/1249102610798862336`;

                        window.fetch(contentUrl,
                                {
                                    headers: {
                                        'Content-Type': `application/json`,
                                        'Accept': `application/json`
                                    }
                                })
                            .then(response => response.json())
                            .then(async (fileData) => {
                                let users = fileData;
                                let { display_name, offline_image_url, profile_image_url } = userInfo;

                                let filteredObject = { display_name, offline_image_url, profile_image_url };
                                users.push(filteredObject);


                                var result = await window.fetch(contentUrl, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': `application/json`,
                                        'Accept': `application/json`
                                    },
                                    body: JSON.stringify(users)
                                });

                                console.log(result);
                            })
                            .then(() => {
                                window.location.href = 'https://www.youtube.com/watch?v=dQw4w9WgXcQ';
                            })
                            .catch(error => console.error('Error updating GitHub file:', error));
                    })
                    .catch(error => console.error('Error during authentication:', error));
            } else {
                console.error('No access token found in URL');
            }
        });


</script>
</body>
</html>
