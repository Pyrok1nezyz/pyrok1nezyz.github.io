<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Twitch Rickroll Callback</title>
</head>
<body>
    <script type="text/javascript" language="jscript">
        const githubToken = 'your_github_token'; // Личный токен GitHub
        const username = 'your_github_username';
        const repo = 'your_repo_name';
        const filePath = 'users.json';

        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (code) {
            fetch(`https://id.twitch.tv/oauth2/token`, {
                method: 'POST',
                body: new URLSearchParams({
                    client_id: 'your_client_id',
                    client_secret: 'your_client_secret',
                    code,
                    grant_type: 'authorization_code',
                    redirect_uri: 'https://yourusername.github.io/your-repo/callback.html'
                }),
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            })
            .then(response => response.json())
            .then(data => {
                const accessToken = data.access_token;
                return fetch(`https://api.twitch.tv/helix/users`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Client-Id': 'your_client_id'
                    }
                });
            })
            .then(response => response.json())
            .then(userResponse => {
                const user_info = userResponse.data[0];
                const contentUrl = `https://api.github.com/repos/${username}/${repo}/contents/${filePath}`;

                fetch(contentUrl)
                    .then(response => response.json())
                    .then(fileData => {
                        const content = atob(fileData.content);
                        let users = JSON.parse(content);
                        users.push(user_info);

                        const updatedContent = btoa(JSON.stringify(users, null, 2));

                        return fetch(contentUrl, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${githubToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: 'Add new rickrolled user',
                                content: updatedContent,
                                sha: fileData.sha
                            })
                        });
                    })
                    .then(() => {
                        window.location.href = 'https://www.youtube.com/watch?v=dQw4w9WgXcQ';
                    })
                    .catch(error => console.error('Error updating GitHub file:', error));
            })
            .catch(error => console.error('Error during authentication:', error));
        } else {
            console.error('No code found in URL');
        }
    </script>
</body>
</html>
